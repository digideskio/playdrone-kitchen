<% node[:glusterfs][:hosts].each do |host| -%>
volume vol-<%= host %>
  type protocol/client
  option transport-type tcp
  option remote-host <%= host %>
  option transport.socket.nodelay on
  option remote-port 6996
  option remote-subvolume iothreads
  option username <%= node[:glusterfs][:username] %>
  option password <%= node[:glusterfs][:password] %>
end-volume

<% end -%>
volume mirror-0
  type cluster/replicate
  subvolumes <%= node[:glusterfs][:hosts].map { |host| "vol-#{host}"}.join(" ") %>
  <% if current_host = ([node[:hostname], node[:fqdn], node[:ipaddress]] & node[:glusterfs][:hosts]).first -%>
  option read-subvolume vol-<%= current_host %>
  <% end -%>
end-volume

volume writebehind
  type performance/write-behind
  option cache-size 4MB
  subvolumes mirror-0
end-volume

volume iothreads
  type performance/io-threads
  option thread-count 16
  subvolumes writebehind
end-volume

volume iocache
  type performance/io-cache
  option cache-size 64MB
  option cache-timeout 30
  subvolumes iothreads
end-volume

volume statprefetch
  type performance/stat-prefetch
  subvolumes iocache
end-volume
